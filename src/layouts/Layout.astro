---
import "@/styles/global.css";
import { ClientRouter } from "astro:transitions";
import LoadingIndicator from "astro-loading-indicator/component";
import { Toaster } from "react-hot-toast";
import AsideMenu from "@/components/AsideMenu.astro";
import Header from "@/components/Header";
import Player from "@/components/Player";
import { getRadioBrowserApi } from "@/lib/radio-browser";

interface Props {
	title: string;
}

const { title } = Astro.props;

interface CountryResult {
	name: string;
	iso_3166_1: string;
	stationcount: number;
}

const api = await getRadioBrowserApi();
const rawCountries = (await api.getCountries()) as CountryResult[];
const countries = rawCountries
	.map((c) => ({
		name: c.name,
		code: c.iso_3166_1,
		stationCount: c.stationcount,
	}))
	.filter((c) => c.code && c.stationCount > 0)
	.sort((a, b) => a.name.localeCompare(b.name));

const searchParams = Astro.url.searchParams;
const currentSearch = searchParams.get("q") || "";
const currentCountry = searchParams.get("country") || "ES";
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
	</head>
	<body>
		<Toaster client:load position="bottom-right" />
		<ClientRouter />
		<LoadingIndicator color="blue" />
		<div id="app" class="relative min-h-screen grid gap-2 p-2 sm:p-4">
			<div class="[grid-area:header] sticky top-0 z-40">
				<Header
					client:load
					countries={countries}
					initialSearch={currentSearch}
					initialCountry={currentCountry}
				/>
			</div>

			<!-- Mobile Sidebar Overlay -->
			<div
				id="sidebar-overlay"
				class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 md:hidden opacity-0 pointer-events-none transition-opacity duration-300"
			>
			</div>

			<aside
				id="sidebar"
				class="[grid-area:aside] fixed inset-y-0 left-0 z-50 w-[280px] md:w-auto md:h-auto md:relative md:z-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex-col flex min-h-0 bg-card md:rounded-2xl shadow-2xl md:shadow-none"
			>
				<AsideMenu />
			</aside>

			<main
				class="[grid-area:main] bg-card rounded-2xl min-h-0 overflow-hidden"
			>
				<slot />
			</main>

			<footer
				class="[grid-area:player] sticky bottom-0 z-40 h-[80px] overflow-hidden"
			>
				<Player client:load transition:persist />
			</footer>
		</div>

		<script>
			import { useUIStore } from "@/stores/useUIStore";

			const sidebar = document.getElementById("sidebar");
			const overlay = document.getElementById("sidebar-overlay");

			if (sidebar && overlay) {
				useUIStore.subscribe((state) => {
					if (state.isMobileMenuOpen) {
						sidebar.classList.remove("-translate-x-full");
						overlay.classList.remove("opacity-0", "pointer-events-none");
					} else {
						sidebar.classList.add("-translate-x-full");
						overlay.classList.add("opacity-0", "pointer-events-none");
					}
				});

				overlay.addEventListener("click", () => {
					useUIStore.getState().setMobileMenuOpen(false);
				});
			}
		</script>
	</body>
</html>

<style>
	#app {
		display: grid;
		grid-template-areas:
			"header"
			"main"
			"player";
		grid-template-columns: 1fr;
		grid-template-rows: auto 1fr auto;
		height: 100vh;
		height: 100dvh;
	}

	@media (min-width: 768px) {
		#app {
			grid-template-areas:
				"header header"
				"aside main"
				"player player";
			grid-template-columns: 320px 1fr;
		}
	}
</style>

---
import { SquareArrowOutUpRight } from 'lucide-react';
import ErrorState from "@/components/ErrorState.astro";
import PlayButton from "@/components/PlayButton";
import Logo from "@/icons/Logo.astro";
import Layout from "@/layouts/Layout.astro";
import { getRadioBrowserApi, withRetry } from "@/lib/radio-browser";
import { cleanStation } from "@/lib/station";
import type { Station } from "@/types/station";

const { id } = Astro.params;

if (!id) {
	return Astro.redirect("/");
}

let station: Station | undefined;
let apiError = null;

try {
	const api = await getRadioBrowserApi();
	const rawStations = await withRetry(() => api.getStationsById([id]));
	station = rawStations[0] ? cleanStation(rawStations[0]) : undefined;
} catch (error) {
	console.error("Error fetching station:", error);
	apiError = error;
}

if (!apiError && !station) {
	return Astro.redirect("/404");
}

const hasFavicon = station?.favicon && station.favicon.trim() !== "";
---

<Layout title={station ? `${station.name} - Simple Radio Browser` : "Error - Simple Radio Browser"}>
	<div class="relative flex flex-col h-full overflow-hidden bg-zinc-900 text-zinc-100">
		<!-- Background Gradient Overlay -->
		<div class="absolute inset-0 bg-linear-to-b from-blue-600/20 to-zinc-900 pointer-events-none"></div>

		<div class="relative z-10 flex-1 overflow-y-auto px-6 py-8">
			{apiError ? (
				<div class="max-w-[1000px] mx-auto h-full flex flex-col justify-center">
					<ErrorState 
						title="Connection Failed" 
						message="We're having trouble reaching the radio station database. Please try again later."
						retry={true}
					/>
				</div>
			) : (
				station && (
			<div class="max-w-[800px] mx-auto flex flex-col items-center">
				<!-- Station Title Top -->
				<div class="text-center mb-6">
					<h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6" transition:name={`station-name-${station.id}`}>
						{station.name}
					</h1>
					<div class="flex flex-wrap justify-center gap-2">
						{station.tags.map(tag => (
								<span class="px-3 py-1 bg-zinc-800/50 rounded-full text-xs text-zinc-400 border border-white/5">#{tag}</span>
						))}
					</div>
				</div>

				<!-- Centered Image -->
				<div 
					class="w-50 h-50 md:w-64 md:h-64 shrink-0  rounded-3xl overflow-hidden bg-zinc-800 flex items-center justify-center mb-12 "
					transition:name={`station-image-${station.id}`}
				>
						{hasFavicon ? (
							<img 
								src={station.favicon} 
								alt={station.name} 
								class="w-full h-full object-cover"
								onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
							/>
							<div class="hidden w-1/2 h-1/2 opacity-20">
								<Logo />
							</div>
						) : (
							<div class="w-1/2 h-1/2 opacity-20">
								<Logo />
							</div>
						)}
				</div>

				<!-- Play Button Below -->
				<div class="mb-16">
					<PlayButton client:load station={station} />
				</div>

				<!-- Details in Cards -->
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
					<div class="bg-zinc-800/30 p-8 rounded-3xl border border-white/5 backdrop-blur-sm">
						<h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Location</h4>
						<p class="text-xl font-medium">{station.country} {station.state && station.state !== station.country && `â€¢ ${station.state}`}</p>
					</div>

					<div class="bg-zinc-800/30 p-8 rounded-3xl border border-white/5 backdrop-blur-sm">
						<h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Popularity</h4>
						<p class="text-4xl font-black">{station.votes.toLocaleString()} <span class="text-sm font-normal text-zinc-500 tracking-normal ml-1">votes</span></p>
					</div>

					{station.homepage && (
							<div class="md:col-span-2">
								<a 
									href={station.homepage} 
									target="_blank" 
									rel="noopener noreferrer"
									class="flex items-center justify-center gap-3 py-6 bg-zinc-100 text-black font-black uppercase text-sm tracking-widest rounded-3xl hover:bg-white transition-colors"
								>
									Visit Website
									<SquareArrowOutUpRight />
								</a>
							</div>
					)}
				</div>
			</div>
		))}
		</div>
	</div>
</Layout>

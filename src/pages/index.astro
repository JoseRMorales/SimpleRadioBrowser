---
import { XIcon } from "lucide-react";
import ErrorState from "@/components/ErrorState.astro";
import StationCard from "@/components/StationCard.astro";
import Layout from "@/layouts/Layout.astro";
import { getRadioBrowserApi, withRetry } from "@/lib/radio-browser";
import { cleanStation } from "@/lib/station";
import type { Station } from "@/types/station";

const search = Astro.url.searchParams.get("q") || "";
const countryCode = Astro.url.searchParams.get("country") || "ES";
const tag = Astro.url.searchParams.get("tag") || "";

let stations: Station[] = [];
let error = null;

try {
	const api = await getRadioBrowserApi();
	const rawStations = await withRetry(() =>
		api.searchStations({
			...(search ? { name: search } : {}),
			...(tag ? { tag: tag } : {}),
			countryCode: countryCode,
			limit: 30,
			order: "votes",
			reverse: true,
			hideBroken: true,
		}),
	);
	stations = rawStations.map(cleanStation);
} catch (e) {
	console.error("Failed to fetch stations:", e);
	error = e;
}
---

<Layout title="Simple Radio Browser">
	<div
		id="playlist-container"
		class="relative transition-all duration-1000 overflow-y-auto h-full bg-blue-400/60 bg-linear-to-t from-card via-zinc-900 bg-local"
		transition:animate="fade"
	>
		{
			error ? (
				<ErrorState retry={true} />
			) : (
				<div class="relative z-10 px-6 max-w-[1500px] mx-auto h-full flex flex-col">
					<div class="flex items-center justify-between py-6">
						<h1 class="text-2xl font-bold text-zinc-100">
							{search ? (
								`Results for "${search}"`
							) : tag ? (
								<div class="flex items-center gap-2">
									<span>Tag: {tag}</span>
									<a
										href="/"
										class="text-zinc-500 hover:text-zinc-100 transition-colors"
										title="Clear tag"
									>
										<XIcon size={20} />
									</a>
								</div>
							) : (
								"Top Stations"
							)}
						</h1>
					</div>

					{stations.length > 0 ? (
						<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-x-4 gap-y-6 pb-6">
							{stations.map((station: Station) => (
								<StationCard station={station} />
							))}
						</div>
					) : (
						<div class="flex-1 flex flex-col items-center justify-center text-zinc-500 py-20">
							<p class="text-lg">No stations found for this search.</p>
							<a href="/" class="text-blue-400 hover:underline mt-2">
								Clear search
							</a>
						</div>
					)}
				</div>
			)
		}
	</div>
</Layout>
